{
  "id": "bf7b17db-eb58-4014-ab2b-e4bf9d3b28f1",
  "name": "DownloadArtifactsTfsGit",
  "friendlyName": "Download Artifacts - External TFS Git",
  "description": "Download TFS Git code repository using Git Clone",
  "author": "ms-vscs-rm",
  "helpMarkDown": "[More Information](https://marketplace.visualstudio.com/items?itemName=ms-vscs-rm.vss-services-externaltfs)",
  "category": "Utility",
  "visibility": [
    "Build",
    "Release"
  ],
  "demands": [],
  "version": {
    "Major": 16,
    "Minor": 264,
    "Patch": 0
  },
  "minimumAgentVersion": "2.144.0",
  "instanceNameFormat": "Download Artifacts - External TFS Git",
  "inputs": [
    {
      "name": "connectionType",
      "type": "pickList",
      "label": "Service Connection Type",
      "defaultValue": "reposOrTfs",
      "required": true,
      "options": {
        "reposOrTfs": "Azure Repos/Team Foundation Server",
        "ado": "Azure DevOps (in preview)"
      },
      "helpMarkDown": "Select which connection to use for artifact discovery and download."
    },
    {
      "name": "connection",
      "type": "connectedService:Externaltfs",
      "label": "Azure Repos/Team Foundation Server service connection",
      "defaultValue": "",
      "visibleRule": "connectionType = reposOrTfs",
      "helpMarkDown": "Select Azure Repos/Team Foundation Server service connection"
    },
    {
      "name": "azureDevOpsServiceConnection",
      "type": "connectedService:workloadidentityuser",  
      "label": "Azure DevOps service connection",
      "defaultValue": "",
      "visibleRule": "connectionType = ado",
      "helpMarkDown": "Select Azure DevOps service connection (in preview)"
    },
    {
      "name": "project",
      "type": "pickList",
      "label": "Project",
      "defaultValue": "",
      "required": true,
      "visibleRule": "connectionType = reposOrTfs",
      "properties": {
        "EditableOptions": "True"
      },
      "helpMarkDown": "Select the project"
    },
    {
      "name": "definition",
      "type": "pickList",
      "label": "Repository",
      "defaultValue": "",
      "required": true,
      "visibleRule": "connectionType = reposOrTfs",
      "properties": {
        "EditableOptions": "True"
      },
      "helpMarkDown": "Select the repository"
    },
    {
      "name": "branch",
      "type": "pickList",
      "label": "Branch",
      "defaultValue": "",
      "required": true,
      "visibleRule": "connectionType = reposOrTfs",
      "properties": {
        "EditableOptions": "True"
      },
      "helpMarkDown": "Select the branch to checkout"
    },
    {
      "name": "version",
      "type": "pickList",
      "label": "Commit ID",
      "defaultValue": "",
      "required": true,
      "visibleRule": "connectionType = reposOrTfs",
      "properties": {
        "EditableOptions": "True"
      },
      "helpMarkDown": "Select the commit ID"
    },
    {
      "name": "projectAdo",
      "type": "pickList",
      "label": "Project",
      "defaultValue": "",
      "required": true,
      "visibleRule": "connectionType = ado",
      "properties": {
        "EditableOptions": "True"
      },
      "helpMarkDown": "Select the project"
    },
    {
      "name": "definitionAdo",
      "type": "pickList",
      "label": "Repository",
      "defaultValue": "",
      "required": true,
      "visibleRule": "connectionType = ado",
      "properties": {
        "EditableOptions": "True"
      },
      "helpMarkDown": "Select the repository"
    },
    {
      "name": "branchAdo",
      "type": "pickList",
      "label": "Branch",
      "defaultValue": "",
      "required": true,
      "visibleRule": "connectionType = ado",
      "properties": {
        "EditableOptions": "True"
      },
      "helpMarkDown": "Select the branch to checkout"
    },
    {
      "name": "versionAdo",
      "type": "pickList",
      "label": "Commit ID",
      "defaultValue": "",
      "required": true,
      "visibleRule": "connectionType = ado",
      "properties": {
        "EditableOptions": "True"
      },
      "helpMarkDown": "Select the commit ID"
    },
    {
      "name": "downloadPath",
      "type": "string",
      "label": "Download Path",
      "defaultValue": "",
      "required": true,
      "helpMarkDown": "Path on the agent machine where the artifacts will be downloaded"
    }
  ],
  "dataSourceBindings": [
    {
      "target": "project",
      "endpointId": "$(connection)",
      "dataSourceName": "Projects",
      "resultTemplate": "{ \"Value\" : \"{{{id}}}\", \"DisplayValue\" : \"{{{name}}}\" }"
    },
    {
      "target": "definition",
      "endpointId": "$(connection)",
      "dataSourceName": "Repositories",
      "parameters": {
        "project": "$(project)"
      },
      "resultTemplate": "{ \"Value\" : \"{{{id}}}\", \"DisplayValue\" : \"{{{name}}}\" }"
    },
    {
      "target": "branch",
      "endpointId": "$(connection)",
      "dataSourceName": "Branches",
      "parameters": {
        "project": "$(project)",
        "definition": "$(definition)"
      },
      "resultTemplate": "{ \"Value\" : \"{{{ #stringReplace 'refs/heads/' '' name}}}\", \"DisplayValue\" : \"{{{ #stringReplace 'refs/heads/' '' name}}}\" }"
    },
    {
      "target": "version",
      "endpointId": "$(connection)",
      "dataSourceName": "GitCommits",
      "parameters": {
        "project": "$(project)",
        "definition": "$(definition)",
        "branch": "$(branch)"
      },
      "resultTemplate": "{ \"Value\" : \"{{{commitId}}}\", \"DisplayValue\" : \"{{{ #subString 0 8 commitId }}}\" }"
    },
    {
      "target": "projectAdo",
      "endpointId": "$(azureDevOpsServiceConnection)",
      "dataSourceName": "Projects",
      "resultTemplate": "{ \"Value\" : \"{{{id}}}\", \"DisplayValue\" : \"{{{name}}}\" }",
      "parameters": {
        "top": 1000
      }
    },
    {
      "target": "definitionAdo",
      "endpointId": "$(azureDevOpsServiceConnection)",
      "dataSourceName": "Repositories",
      "parameters": {
        "project": "$(projectAdo)"
      },
      "resultTemplate": "{ \"Value\" : \"{{{id}}}\", \"DisplayValue\" : \"{{{name}}}\" }"
    },
    {
      "target": "branchAdo",
      "endpointId": "$(azureDevOpsServiceConnection)",
      "dataSourceName": "Branches",
      "parameters": {
        "project": "$(projectAdo)",
        "definition": "$(definitionAdo)"
      },
      "resultTemplate": "{ \"Value\" : \"{{{ #stringReplace 'refs/heads/' '' name}}}\", \"DisplayValue\" : \"{{{ #stringReplace 'refs/heads/' '' name}}}\" }"
    },
    {
      "target": "versionAdo",
      "endpointId": "$(azureDevOpsServiceConnection)",
      "dataSourceName": "GitCommits",
      "parameters": {
        "project": "$(projectAdo)",
        "definition": "$(definitionAdo)",
        "branch": "$(branchAdo)"
      },
      "resultTemplate": "{ \"Value\" : \"{{{commitId}}}\", \"DisplayValue\" : \"{{{ #subString 0 8 commitId }}}\" }"
    }
  ],
  "execution": {
    "Node16": {
      "target": "downloadTfGit.js",
      "argumentFormat": ""
    },
    "Node20": {
      "target": "downloadTfGit.js",
      "argumentFormat": ""
    }
  }
}
