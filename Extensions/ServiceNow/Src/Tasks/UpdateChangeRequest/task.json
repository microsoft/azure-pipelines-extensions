{
  "id": "37AC13CA-AEAD-4E19-A5AC-E5366051FC1C",
  "name": "UpdateServiceNowChangeRequest",
  "friendlyName": "Update ServiceNow Change Request",
  "description": "Update ServiceNow Change Request",
  "author": "Microsoft",
  "helpMarkDown": "",
  "category": "Utility",
  "visibility": [
    "Release"
  ],
  "runsOn": [
    "Server"
  ],
  "version": {
    "Major": 0,
    "Minor": 1,
    "Patch": 0
  },
  "instanceNameFormat": "Update ServiceNow Change Request",
  "groups": [
    {
      "name": "advancedInputs",
      "displayName": "Advanced",
      "isExpanded": false
    }
  ],

  "inputs": [
    {
      "name": "ServiceNowConnection",
      "type": "connectedService:ServiceNow",
      "label": "ServiceNow connection",
      "defaultValue": "",
      "required": "true",
      "helpMarkDown": "Connection to the ServiceNow instance used for change management."
    },
    {
      "name": "ChangeRequestNumber",
      "type": "string",
      "label": "Change Request Number",
      "defaultValue": "",
      "required": true,
      "helpMarkDown": "Change request to update. Must be a valid change request number in ServiceNow."
    },
    {
      "name": "NewStatus",
      "type": "pickList",
      "label": "Updated status of change request",
      "required": "true",
      "helpMarkDown": "Status (label or value) to set for the change request.",
      "properties": {
        "EditableOptions": "True"
      }
    },

    {
      "name": "CloseCode",
      "type": "pickList",
      "label": "Close code",
      "required": "true",
      "helpMarkDown": "Close code (label or value) for the change request",
      "properties": {
        "EditableOptions": "True"
      },
      "visibleRule": "NewStatus = Closed"
    },
    {
      "name": "CloseNotes",
      "type": "text",
      "label": "Close notes",
      "required": "true",
      "defaultValue": "",
      "helpMarkDown": "Notes to be added as closure information to the change request",
      "visibleRule": "NewStatus = Closed"
    },
    {
      "name": "otherParameters",
      "type": "multiLine",
      "label": "Additional change request parameters",
      "required": "false",
      "groupName": "advancedInputs",
      "helpMarkDown": "Additional change request properties to set. Specified as Key-value pairs in json format, name being the field name (not label) prefixed with 'u_' in ServiceNow and a valid value. Invalid properties are ignored.",
      "properties": {
        "editorExtension": "ms.vss-services-azure.azure-servicebus-message-grid"
      }
    }
  ],
  "dataSourceBindings": [
    {
      "target": "NewStatus",
      "endpointId": "$(ServiceNowConnection)",
      "dataSourceName": "State"
    },
    {
      "target": "CloseCode",
      "endpointId": "$(ServiceNowConnection)",
      "dataSourceName": "Close code"
    }
  ],

  "execution": {
    "HttpRequestChain": {
      "Execute": [
        {
          "RequestInputs": {
            "EndpointId": "$(ServiceNowConnection)",
            "EndpointUrl": "$(endpoint.url)/api/now/table/change_request?sysparm_query=number=$(ChangeRequestNumber)&sysparm_fields=correlation_id,number",
            "Method": "GET",
            "Headers": "{\"Content-Type\":\"application/json\", \"Accept\":\"application/json\"}",
            "WaitForCompletion": "false",
            "Expression": "eq(jsonpath('$.result[0].number')[0], '$(ChangeRequestNumber)')"
          },
          "ExecutionOptions": {
            "OutputVariables": "{\"CHANGE_CORRELATION_ID\" :  \"jsonpath('$.result[0].correlation_id')[0]\"}"
          }
        },
        {
          "RequestInputs": {
            "EndpointId": "$(ServiceNowConnection)",
            "EndpointUrl": "$(endpoint.url)/api/now/import/x_mioms_azpipeline_change_request_import",
            "Method": "POST",
            "Body": "{\"u_correlation_id\": \"$(CHANGE_CORRELATION_ID)\",\"u_state\": \"$(NewStatus)\"{{#equals '$(NewStatus)' 'Closed'}}, \"u_close_code\": \"$(CloseCode)\", \"u_close_notes\": \"$(CloseNotes)\"{{/equals}} {{#if otherParameters}}{{toCommaSeparatedKeyValueList otherParameters true}}{{/if}} }",
            "Headers": "{\"Content-Type\":\"application/json\", \"Accept\":\"application/json\"}",
            "WaitForCompletion": "false",
            "Expression": "eq(jsonpath('$.result[0].status')[0], 'updated')"
          },
          "ExecutionOptions": {
            "OutputVariables": "{\"CHANGE_REQUEST_URL\" :  \"jsonpath('$.result[0].record_link')[0]\"}",
            "SkipSectionExpression": "eq(isNullOrEmpty(variables['CHANGE_REQUEST_URL']), false)"
          }
        }
      ]
    }
  }
}

